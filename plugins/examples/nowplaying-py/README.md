# Now Playing Logger Plugin (Python)

A Python example plugin that demonstrates the **Scheduler** and **SubsonicAPI** host services by periodically logging what is currently playing in Navidrome.

## Features

- Uses `scheduler_schedule_recurring` host function to set up a recurring task
- Uses `subsonicapi_call` host function to query the `getNowPlaying` API
- Configurable cron expression and user via plugin config
- Uses generated Python host function wrappers from `plugins/host/python/`

## Prerequisites

- [extism-py](https://github.com/extism/python-pdk) - Python PDK compiler
  ```bash
  curl -Ls https://raw.githubusercontent.com/extism/python-pdk/main/install.sh | bash
  ```

> **Note:** `extism-py` requires [Binaryen](https://github.com/WebAssembly/binaryen/) (`wasm-merge`, `wasm-opt`) to be installed.

## Building

From the `plugins/examples` directory:

```bash
make nowplaying-py.wasm
```

Or directly:

```bash
PYTHONPATH=plugin extism-py plugin/__init__.py -o nowplaying-py.wasm
```

## Installation

1. Copy `nowplaying-py.wasm` to your Navidrome plugins folder

2. Enable plugins in `navidrome.toml`:
   ```toml
   [Plugins]
   Enabled = true
   Folder = "/path/to/plugins"
   ```

3. Configure the plugin (optional):
   ```toml
   [PluginConfig.nowplaying-py]
   cron = "*/1 * * * *"  # Check every minute (default)
   user = "admin"        # Navidrome user for API calls (default)
   ```

### Configuration Options

| Key    | Description                         | Default                      |
|--------|-------------------------------------|------------------------------|
| `cron` | Cron expression for check frequency | `*/1 * * * *` (every minute) |
| `user` | Navidrome user for SubsonicAPI      | `admin`                      |

## Testing

Test the manifest:

```bash
extism call nowplaying-py.wasm nd_manifest --wasi
```

## Output

When running, the plugin logs messages like:

```
ðŸŽµ john is playing: Pink Floyd - Comfortably Numb (The Wall)
ðŸŽµ jane is playing: Radiohead - Paranoid Android (OK Computer)
```

Or when no one is playing:

```
ðŸŽµ No users currently playing music
```

## How It Works

1. **Initialization (`nd_on_init`)**: Reads the cron expression from config and schedules a recurring task using the Scheduler host service.

2. **Callback (`nd_scheduler_callback`)**: When the scheduled task fires, calls the SubsonicAPI `getNowPlaying` endpoint and logs the results.

## Using Generated Host Function Wrappers

This plugin uses the generated Python host function wrappers from `plugins/host/python/`. These wrappers are generated by `hostgen` and provide type-safe, Pythonic interfaces to Navidrome host functions:

```python
# Import generated host function wrappers
from nd_host_scheduler import scheduler_schedule_recurring, HostFunctionError
from nd_host_subsonicapi import subsonicapi_call

# Use them directly - no manual JSON marshalling needed!
schedule_id = scheduler_schedule_recurring(
    cron_expression="*/1 * * * *",
    payload="check",
    schedule_i_d="nowplaying-check"
)

response_json = subsonicapi_call(uri="getNowPlaying")
```

The wrappers handle:
- JSON marshalling/unmarshalling
- Memory allocation and management  
- Error handling (raises `HostFunctionError` on failure)
- Type hints for better IDE support