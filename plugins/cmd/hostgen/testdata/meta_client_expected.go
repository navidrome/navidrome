// Code generated by hostgen. DO NOT EDIT.
//
// This file contains client wrappers for the Meta host service.
// It is intended for use in Navidrome plugins built with TinyGo.

package main

import (
	"encoding/json"
	"errors"

	"github.com/extism/go-pdk"
)

// meta_get is the host function provided by Navidrome.
//
//go:wasmimport extism:host/user meta_get
func meta_get(uint64) uint64

// meta_set is the host function provided by Navidrome.
//
//go:wasmimport extism:host/user meta_set
func meta_set(uint64) uint64

// MetaGetResponse is the response type for Meta.Get.
type MetaGetResponse struct {
	Value any    `json:"value,omitempty"`
	Error string `json:"error,omitempty"`
}

// MetaGet calls the meta_get host function.
func MetaGet(key string) (*MetaGetResponse, error) {
	keyMem := pdk.AllocateString(key)
	defer keyMem.Free()

	// Call the host function
	responsePtr := meta_get(keyMem.Offset())

	// Read the response from memory
	responseMem := pdk.FindMemory(responsePtr)
	responseBytes := responseMem.ReadBytes()

	// Parse the response
	var response MetaGetResponse
	if err := json.Unmarshal(responseBytes, &response); err != nil {
		return nil, err
	}

	if response.Error != "" {
		return nil, errors.New(response.Error)
	}

	return &response, nil
}

// MetaSet calls the meta_set host function.
func MetaSet(data map[string]any) error {
	dataBytes, err := json.Marshal(data)
	if err != nil {
		return err
	}
	dataMem := pdk.AllocateBytes(dataBytes)
	defer dataMem.Free()

	// Call the host function
	responsePtr := meta_set(dataMem.Offset())

	// Read the response from memory
	responseMem := pdk.FindMemory(responsePtr)
	errStr := string(responseMem.ReadBytes())

	if errStr != "" {
		return errors.New(errStr)
	}

	return nil
}
