// Code generated by ndpgen. DO NOT EDIT.
//
// This file contains client wrappers for the HttpClient host service.
// It is intended for use in Navidrome plugins built with TinyGo.
//
//go:build wasip1

package host

import (
	"encoding/json"
	"errors"

	"github.com/navidrome/navidrome/plugins/pdk/go/pdk"
)

// HttpRequest represents the HttpRequest data structure.
// HttpRequest represents an outbound HTTP request from a plugin.
type HttpRequest struct {
	Method    string            `json:"method"`
	URL       string            `json:"url"`
	Headers   map[string]string `json:"headers"`
	Body      []byte            `json:"body"`
	TimeoutMs int32             `json:"timeoutMs"`
}

// HttpResponse represents the HttpResponse data structure.
// HttpResponse represents the response from an outbound HTTP request.
type HttpResponse struct {
	StatusCode int32             `json:"statusCode"`
	Headers    map[string]string `json:"headers"`
	Body       []byte            `json:"body"`
}

// httpclient_do is the host function provided by Navidrome.
//
//go:wasmimport extism:host/user httpclient_do
func httpclient_do(uint64) uint64

type httpClientDoRequest struct {
	Request HttpRequest `json:"request"`
}

type httpClientDoResponse struct {
	Result *HttpResponse `json:"result,omitempty"`
	Error  string        `json:"error,omitempty"`
}

// HttpClientDo calls the httpclient_do host function.
// Do executes an HTTP request and returns the response.
//
// Parameters:
//   - request: The HTTP request to execute, including method, URL, headers, body, and timeout
//
// Returns the HTTP response with status code, headers, and body.
// Network errors, timeouts, and permission failures are returned as Go errors.
// Successful HTTP calls (including 4xx/5xx status codes) return a non-nil response with nil error.
func HttpClientDo(request HttpRequest) (*HttpResponse, error) {
	// Marshal request to JSON
	req := httpClientDoRequest{
		Request: request,
	}
	reqBytes, err := json.Marshal(req)
	if err != nil {
		return nil, err
	}
	reqMem := pdk.AllocateBytes(reqBytes)
	defer reqMem.Free()

	// Call the host function
	responsePtr := httpclient_do(reqMem.Offset())

	// Read the response from memory
	responseMem := pdk.FindMemory(responsePtr)
	responseBytes := responseMem.ReadBytes()

	// Parse the response
	var response httpClientDoResponse
	if err := json.Unmarshal(responseBytes, &response); err != nil {
		return nil, err
	}

	// Convert Error field to Go error
	if response.Error != "" {
		return nil, errors.New(response.Error)
	}

	return response.Result, nil
}
